FROM node:22 AS base

WORKDIR /app

# Install pnpm in the builder stage
RUN corepack enable && corepack prepare pnpm@10.10.0 --activate

# Copy the application code
COPY . .

# Set environment variables at build time via build-args
# Add your required environment variables here
ARG NEXT_PUBLIC_BACKEND_URL
ARG NEXT_PUBLIC_SITE_URL

ENV NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
ENV NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
ENV NODE_ENV=production

# Force clean install to avoid dependency conflicts
RUN rm -rf node_modules
RUN rm -rf pnpm-lock.yaml

WORKDIR /app/apps/ts-monorepo-boilerplate-nextjs

# Install all dependencies
RUN pnpm install

# Build the Next.js application
RUN pnpm build

# Expose the port Next.js runs on
EXPOSE 3000

# Set a healthcheck
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD wget -q --spider http://localhost:3000/ || exit 1

# Start the Next.js production server
CMD ["pnpm", "start", "--port", "3000"]
